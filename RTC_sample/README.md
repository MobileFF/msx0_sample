# MSX0に内蔵されているRTC(BM8563)をIoT BASICからアクセスするサンプル<!-- omit in toc -->

## 能書き

MSX0に内蔵されているRTC(BM8563)にIoT BASICからアクセスして、任意の時刻を記録したり、それを読み出したりするサンプルコードです。

- SETMSXOT.BAS
  - BM8563に、MSX Origin Time(筆者が勝手に定義した日時)を書き込みます
- MSXOTCLK.BAS
  - MSX0の時刻と、BM8563に記録されている時刻を同時に表示します

## MSX0における時刻の管理

MSX0 StackのベースとなっているM5 Stackは、BM8563というRTC(Real Time Clock)を内蔵しています。

MSX規格ではMSX2から時計を内蔵するようになり、時刻管理ができるようになりましたので、MSX0をMSX2以上のモードで動かせば、BM8563に時刻が書き込まれて利用される（`GET TIME`/`GET DATE`で取得する時刻として使える）のかなと思ってしまいそうですが、実はそうではありません。

MSX0付属のマニュアル「`1_MSX0Stack利用方法.pdf`」のp80にも言及がありますが、MSX0は現状、起動時にWiFiが有効な場合はNTPにアクセスして現在日時を取得し、以降の起動中のMSXとしての日時管理は仮想的なRTCで行っているため、BM8563はMSX0からは使われていません。

そのため、BM8563を利用すれば、MSX0標準の日時とは独立した全く別の日時を管理することが可能です。

## BM8563へのアクセス

BM8563は、IoT BASICではノードパス`"device/i2c_i/51"`でアクセスすることができます。

デバイスを初期化するには、`00H,00H,01H,00H,0DH,00H`の順に値を送ります。
基本的に、１個目に送る値がレジスタの番号、続いて送るのがそのレジスタにセットしたい値です。
つまり上記は、
|レジスタ番号 | セットしたい値 |
|------|--------|
|00H|00H|
|01H|00H|
|0DH|00H|

のようにしていると解釈されます。

次に、レジスタ番号に`02H`を指定すると、その後は7バイトのデータを連続して送ることができ、年、月、曜日、日、時、分、秒の順に値を送ります。

詳しくは、データシートなどをご覧いただきたいのですが、年については、1900年からの差分を記録しますが（例：1983年なら83）、2000年以降については、月の値のbit6（上から２桁目）を1にすると、2000年からの差分とみなされます。

曜日は0＝日、1=月・・・です。

月以外の数値データについては、上位4ビットが１０の位、下位４ビットが１の位になります。

## MSX Origin Timeについて

で、MSX0本体の時計とは別に日時を管理できるようになって、じゃあどうするのって話ではあるのですが、MSX Origin Timeというのを勝手に考えてその時間を記録することにしました。MSX Origin TimeとはMSX企画が発表された1983年6月16日0時0分0秒からの経過日時になりますｗｗ
（記者会見で発表したのかと思いますが、会見の開始時刻がわからないため、時刻は00:00:00としました）


ちなみに、MSX Origin Timeの求め方（1983/6/16 00:00:00との差分の求め方）は、あくまでネタなので至極いい加減です。正確性などは気にしないでくださいww

以上
