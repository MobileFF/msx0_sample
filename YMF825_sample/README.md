# MSX0からYMF825でドレミファソを鳴らすサンプル<!-- omit in toc -->

- [能書き](#能書き)
- [スレーブ側(Arduino)の動作(I2C\_to\_SPI\_v2.ino)](#スレーブ側arduinoの動作i2c_to_spi_v2ino)
- [マスター側(MSX0)の動作(YMF825.bas)](#マスター側msx0の動作ymf825bas)
- [MSX0とArduino、YMF825Boardの接続](#msx0とarduinoymf825boardの接続)
- [おことわり](#おことわり)

## 能書き

MSX0から演奏データをYMF825に送ってドレミファソを鳴らすサンプルコードです。

現状、MSX0ではSPI通信についてはIoT BASICではサポートされていないため、例によってArduinoに仲介させて、MSX0からI2Cで演奏データを書き出し、ArduinoがSPI通信に変換してYMF825Boardに送るという方式をとります。

演奏データやアルゴリズムについては、

[https://github.com/hasebems/YMF825_sample](https://github.com/hasebems/YMF825_sample)

にあるサンプルコードを参考にさせていただきました。

## スレーブ側(Arduino)の動作(I2C_to_SPI_v2.ino)

I2Cでマスタからデータを受信すると、バッファにため込み、予定のバイト数を受信したらSPIスレーブにデータを送信します。

YMF825では一回の命令を複数バイト一度に送るケースがあるため、１バイト受け取るごとにSPIに送信、とはしていません。

また、ここで注意したいのは、ArduinoのI2Cデータの受信バッファは32バイトであるということです。32バイト以上のデータを受け取りそのまま継続しようとするとスレーブデバイスとしてはハングアップのような状態になります。（エラー処理をちゃんと書けば回避できるかもしれないのですが試していないです）

そのため、I2Cマスター(MSX0)からは、いったん命令のバイト数を送信し、続けて命令をそのバイト数分送るようにしています。I2Cスレーブ(Arduino)でも、まず最初の１バイトは命令のバイト数として受信し、次から命令のバイト数分をバッファ配列に溜めるようにしています。

## マスター側(MSX0)の動作(YMF825.bas)

MSX0は通常のI2C通信で、あまり特別なことをしていません。

演奏データは`DATA`文で書かれています。これを`READ`文で読み、`_IOTPUT()`でひたすら書き出すという感じなのですが、今回のプログラム(YMF825へのデータ送信)では

- ２バイトずつ送信するケース(行20000～)
- 36バイト送信するケース(行21000～)
- ２バイト送信で２バイト目だけ`DATA`文を使わないで任意の値を指定するケース(行22000～)
  
の３パターンがあるため、それぞれにサブルーチンを作ってそこに飛ばすようにしています。そのため少しプログラムが複雑に見えると思いますが、飛び先などの行番号にコメントを入れているので、参考になれば幸いです。

## MSX0とArduino、YMF825Boardの接続

今回は、Arduino(3.3V)とYMF825Board(5V)の電源をMSX0から共有してみようと思います。

とりあえず、仲介役のArduino Mini Proとは別に、Arduino UNOを用意します。

MSX0のPORT Aの[5V]と[GND]をArduino UNOの[VIN]と[GND]に繋ぎます。

|ピン|MSX0(PORTA) | Arduino UNO|
|---|-----|------------------|
|5V |[5V] |[VIN]             |
|GND|[GND]|[GND]（どれでもOK）|

すると、Arduino UNOの電源が入りますので、そこから[5V]をYMF825Boardに、[3.3V]をArduino Mini Proに繋ぎます。

|ピン|Arduino UNO | YMF825 Board|Arduino Pro Mini|
|----|-------------------|------|--------------------|
|5V  |[5V]               | [5V] | -                  |
|3.3V|[3.3V]             | -    | [VCC]              |
|GND |[GND]（どれでもOK） | [GND]| [GND]（どれでもOK） |

次にMSX0とArduino Pro Mini、Arduino Pro MiniとYMF825Boardを接続します。

|MSX0(PORTA) | Arduino Pro Mini | YMF825Board |
|------|-----|---------|
|[SDA] |[A4] | -       |
|[SCK] |[A5] | -       |
| -    |[D10]| [SS]    |
| -    |[D11]| [MOSI]  |
| -    |[D12]| [MISO]  |
| -    |[D13]| [SCK]   |
| -    |[D9] | [RST_N] |

## おことわり

上記件に関して、なにぶんにも、中の人は電子工作、電子回路については完全な素人なのでたいしてよくわかっていないことのほうが多いです。

記事の内容をお試しになる場合は、自己責任でお願いいたします。この記事にある通りのことを試してお手持ちの機器を破損しても中の人は一切の責任を負いません。

Arduinoは互換機含め様々入手経路があり、価格も安価なものがたくさんありますが、MSX0については、2023年10月時点で破損すると、基本的には一般販売開始を待たなければいけなくなります。

このことに同意できない方は記事の内容を試されないようにお願いいたします。

以上
